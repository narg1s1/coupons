stages:
  - test_build
  - test
  - showroom_build
  - showroom_deploy
  - stage_build
  - stage_deploy
  - prod_build
  - prod_deploy

test_build:
  stage: test_build
  tags:
    - deploy
  only:
    variables:
      - $IN_STAGE_TYPE == "test"
  script:
    - echo "test build"

test:
  stage: test
  tags:
    - deploy
  only:
    variables:
      - $IN_STAGE_TYPE == "test"
  script:
    - echo "test"

Build to dev:
  stage: showroom_build
  script:
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./Dappfile
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./.helm/templates/01-backend.yaml
    # - sed -i -- "s/coupons-frontend/coupons-frontend-dev/g" ./.helm/Chart.yaml
    - dapp dimg build --name coupons-frontend --build-dir ~/dapp_build/${CI_PROJECT_NAME} ${CI_REGISTRY_IMAGE}
    - dapp dimg push --name coupons-frontend --build-dir ~/dapp_build/${CI_PROJECT_NAME} ${CI_REGISTRY_IMAGE}  registry.devpayever.com --registry-username payever --registry-password vMnPdItXkV9T
  tags:
    - deploy
  only:
    variables:
      - $IN_STAGE_TYPE == "deploy"

Deploy to dev:
  stage: showroom_deploy
  script:
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./Dappfile
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./.helm/templates/01-backend.yaml
    #- sed -i -- "s/coupons-frontend/coupons-frontend-dev/g" ./.helm/Chart.yaml
    - sed -i -- "s/placeholder/coupons-frontend/g" ./sub.sh
    - bash sub.sh
    - dapp --version
    - dapp kube deploy
      --name coupons-frontend
      --namespace developers
      --set "global.env=stage"
      --set "global.git_rev=${CI_BUILD_REF:-$CI_COMMIT_SHA}"
      --set global.ciProjectName=$CI_PROJECT_NAME
      registry.devpayever.com
  tags:
    - deploy
  only:
    variables:
      - $IN_STAGE_TYPE == "deploy"

Build to staging:
  stage: stage_build
  script:
    - bash sub_stage.sh
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./Dappfile
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./.helm/templates/01-backend.yaml
    - sed -i "s/developers/staging/g" ./.helm/templates/01-backend.yaml
    - sed -i "s/developers/staging/g" ./.helm/templates/02-backend-ingress.yaml
    #- sed -i "s/.devpayever.com/.payever.org/g" ./.helm/templates/02-backend-ingress.yaml
    - dapp dimg build --name coupons-frontend --build-dir ~/dapp_build/${CI_PROJECT_NAME} ${CI_REGISTRY_IMAGE}
    - dapp dimg push --name coupons-frontend --build-dir ~/dapp_build/${CI_PROJECT_NAME} ${CI_REGISTRY_IMAGE}  registry.devpayever.com --registry-username payever --registry-password vMnPdItXkV9T
  tags:
    - deploy
  only:
    - master

Deploy to staging:
  stage: stage_deploy
  script:
    - dapp --version
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./Dappfile
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./.helm/templates/01-backend.yaml
    - sed -i "s/developers/staging/g" ./.helm/templates/01-backend.yaml
    - sed -i -- "s/coupons-frontend/coupons-frontend-staging/g" ./.helm/Chart.yaml
    - sed -i "s/developers/staging/g" ./.helm/templates/02-backend-ingress.yaml
    - dapp kube deploy
      --name coupons-frontend
      --namespace staging
      --set "global.env=stage"
      --set "global.git_rev=${CI_BUILD_REF:-$CI_COMMIT_SHA}"
      --set global.ciProjectName=$CI_PROJECT_NAME
      registry.devpayever.com
  tags:
    - deploy
  only:
    - master


Build to prod:
  stage: prod_build
  when: manual
  script:
    - bash sub_prod.sh
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./Dappfile
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./.helm/templates/01-backend.yaml
    - sed -i "s/developers/production/g" ./.helm/templates/01-backend.yaml
    - sed -i "s/developers/production/g" ./.helm/templates/02-backend-ingress.yaml
    - sed -i "s/.devpayever.com/.payever.org/g" ./.helm/templates/02-backend-ingress.yaml
    - sed -i "s/custom-tls-cert-com/custom-tls-cert-org/g" ./.helm/templates/02-backend-ingress.yaml
    - dapp dimg build --name coupons-frontend --build-dir ~/dapp_build/${CI_PROJECT_NAME} ${CI_REGISTRY_IMAGE}
    - dapp dimg push --name coupons-frontend --build-dir ~/dapp_build/${CI_PROJECT_NAME} ${CI_REGISTRY_IMAGE}  registry.devpayever.com --registry-username payever --registry-password vMnPdItXkV9T
  tags:
    - deploy
  only:
    - production

deploy to prod:
  stage: prod_deploy
  when: manual
  script:
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./Dappfile
    - sed -i -- "s/coupons-frontend/$CI_COMMIT_REF_SLUG/g" ./.helm/templates/01-backend.yaml
    - sed -i "s/developers/production/g" ./.helm/templates/01-backend.yaml
    - sed -i "s/developers/production/g" ./.helm/templates/02-backend-ingress.yaml
    - sed -i "s/.devpayever.com/.payever.org/g" ./.helm/templates/02-backend-ingress.yaml
    - sed -i "s/custom-tls-cert-com/custom-tls-cert-org/g" ./.helm/templates/02-backend-ingress.yaml
    - dapp --version
    - dapp kube deploy
      --namespace production
      --set "global.env=stage"
      --set "global.git_rev=${CI_BUILD_REF:-$CI_COMMIT_SHA}"
      --set global.ciProjectName=$CI_PROJECT_NAME
      registry.devpayever.com
  tags:
    - deploy
  only:
    - production
